---
title: "MAE0514 - Introducão a Análise de Sobrevivência - Lista 2"
author: |
  | Bruno de Castro Paul Schultze\thanks{Número USP: 10736862}
  | Rubens Santos Andrade Filho\thanks{Número USP: 10370336}
date: "`r stringr::str_to_sentence(format(Sys.time(), '%B de %Y'))`"
lang: pt-BR
header-includes:
  # - \usepackage[brazilian]{babel} # ja usando lang: pt-BR
  - \usepackage{float}
  - \usepackage{amsmath}
  - \usepackage{amsthm}
  - \floatplacement{figure}{H}
  - \usepackage{indentfirst}
  - \setlength{\parindent}{4em}
  - \setlength{\parskip}{1em}
  - \usepackage{booktabs}
  - \usepackage{dcolumn}
  - \usepackage{bm}
  - \usepackage{titling}
  - \thanksmarkseries{arabic} % \thanks footnotes com numeros
  - \usepackage[bottom]{footmisc} % corrige posição footnotes
  - \usepackage{grffile}
  - \usepackage{pdfpages}
  - \usepackage{tocloft}
  - \renewcommand{\cftsecleader}{\cftdotfill{\cftdotsep}}
  - \usepackage{amssymb}
  - \renewcommand\qedsymbol{$\blacksquare$}
  - \usepackage{pdfpages}
  - \usepackage{cleveref}
  - \usepackage{threeparttable}
output:
  pdf_document: 
    fig_caption: yes
    number_sections: no
    toc: true
    toc_depth: 3
---

\pagebreak

\newcommand\invisiblesection[1]{%
  \refstepcounter{section}%
  \addcontentsline{toc}{section}{#1}%
  \sectionmark{#1}}

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, 
                      # fig.dim = c(5,5),
                      # out.height = '40%',
                      # fig.align = 'center',
                      message=FALSE
                      )

library(tidyverse)
library(ggplot2)
library(knitr)
library(readr)
library(dplyr)


```

\clearpage

# Questão 1


a)

A variável do estudo é o tempo compreendido da exposição a um material cancerígeno até o desenvolvimento do tumor de um tamanho determinado nos ratos. Nesse caso, a origem é a exposição a um material cancerígeno e o evento de interesse é o desenvolvimento do tumor de um tamanho determinado.

b)

Para os rato A, B e C foram observados os tempos de falha, isto é, os tempos até os ratos desenvolverem o tumor de determinado tamanho. 

Para o rato D foi observado uma censura aleatória à direita na vigésima semana, sua morte. Até a semana 20 o rato não tinha desenvolvido o tumor de um tamanho determinado.

Para os ratos E e F foram observados censuras à direita do tipo I na semana 30 por ser a duração do estudo. Ademais, apenas com as informações do enunciado não é possível dizer se todos os ratos foram expostos ao material cancerígeno ao mesmo tempo para sabermos se a censura é generalizada ou não.



\includepdf[pages=1,scale=.8,pagecommand={\section{Questão 2}\label{pdf:q2}},linktodoc=true]{q2.pdf}
\includepdf[pages=2-,scale=.8,pagecommand={},linktodoc=true]{q2.pdf}

# Questão 3

Em um estudo clínico realizado com pacientes com câncer gástrico avançado (com metástase linfodonal), uma quimioterapia com Xeloda (capecipabina) e oxaliplatina foi administrada antes da cirurgia de 48 pacientes. Nesse tipo de ensaio clínico, é de interesse estudar e avaliar o tempo livre da doença, que é o tempo que o paciente fica bem, vivo e sem a doença. Assim, um dos objetivos é estudar o tempo decorrido entre o início do tratamento e óbito ou progressão da doença (o que ocorrer primeiro). Os dados do tempo livre da doença (em semanas) dos 48 pacientes estão disponíveis no arquivo `Lista2-Xelox.csv`, sendo que a variável delta é codificada como sendo 1 se o evento ocorreu e 0 se a observação é censurada.

(a) Calculamos o estimador da tábua de vida, considerando as seguintes faixas de tempo:

\begin{tabular}{|ll|}
\hline Faixa 1: & 8 semanas (inclusive) ou menos \\
Faixa 2: & de 8 a 16 semanas (inclusive) \\
Faixa 3: & de 16 a 24 semanas (inclusive) \\
Faixa 4: & de 24 a 32 semanas (inclusive) \\
Faixa 5: & de 32 a 44 semanas (inclusive) \\
Faixa 6: & de 44 a 56 semanas (inclusive) \\
Faixa 7: & mais de 56 semanas \\
\hline
\end{tabular}

Dessa forma, consideramos os intervalos fechados à direita.

```{r}
# QUESTAO 3a ----

dados_raw <- readr::read_csv2('data/Lista2-Xelox.csv')

# limites dos intervalos
breaks <- c(0,8,16,24,32,44,56, Inf)

tabua <- dados_raw %>% 
  mutate(
    # define as faixas
    intervalo = cut(timeWeeks, breaks=breaks, right=TRUE, include.lowest = T),
    i = as.integer(intervalo)
  ) %>% 
  group_by(intervalo, i) %>% 
  summarise(
    # numero de falhas no intervalo
    d = sum(delta),
    # numero de censuras no intervalo
    w = sum(1-delta)
  ) %>% 
  ungroup() %>% 
  mutate(
    # numero de obs em risco, que nao falharam até o fim do intervalo anterior
    n_estrela = sum(d+w) - cumsum(d+w) +w+d,
    # corrigindo o numero de ind. em risco
    n = n_estrela - w/2,
    # prop. de falhas no intervalo
    q_hat = d/n,
    # na tabua de vida, a estimativa de S do 1o intervalo = 1
    # depois o produtorio acumulado dos p_i
    s_hat = c(1, cumprod(1 - q_hat)[-n()])
  )


```


```{r, echo=FALSE}
tabua %>%
  kable(
    caption = "Estimativas da tábua de vida.", 
    col.names = c(
      "Semanas","$i$","$d_i$","$w_i$",
      "$n*$","$n$", 
      "$q_i$",
      "$\\hat{S}(t)$"))


```

```{r, echo=FALSE}
x = rep(breaks, each=2)[2:15]
x[length(x)] <- 100 # substitui infinito
y = rep(tabua$s_hat, each=2)

plot(x, y, type="l", col=4, xlab="Semanas", ylab=expression(hat(S)),ylim = c(0,1),
     main = "Estimativa da função de sobrevivência pela tábua de vida", cex=.6)


```


Chama a atenção o fato da estimativa da função de sobrevivência não se aproximar de 0 à medida que aumentam o número de semanas. Isso acontece principalmente devido às 11 observações censuradas que ficaram no último intervalo, isto é, temos menos muito menos informação a respeito das falhas nesse intervalo.



(b) Calcule o estimador Kaplan-Meier para os dados (você pode utilizar um software).

```{r, echo=FALSE}
# QUESTAO 3b ----

# vamos criar uma funcao para calcular as estimativas de Kaplan-Meier
estimar_km <- function(dados, tempo, delta) {
  dados %>%
    # agrupa para cada tempo unico
    group_by(t={{ tempo }}) %>%
    # numero de eventos e censuras em cada t
    summarise(d = sum({{ delta }}), w=sum(1-{{ delta }})) %>% 
    ungroup() %>% 
    mutate(
      # numero de individuos vivos até antes de cada instante t
      Y = sum(d+w) - (cumsum(d+w) - (d+w)),
      # estimate of the conditional probability that an individual who survives 
      # to just prior to time ti experiences the event at time ti
      q = d/Y,
      # estimate of surv function
      s_hat = cumprod(1 - q)
    ) %>% 
    filter(d!=0)
}

tabela_km <- function(estimativa_km, caption="Estimativas de Kaplan-Meier.",
                      col.names = c("Tempo","$d_i$","$w_i$","$Y_i$", 
                                    "$q_i=d_i/Y_i$", "$\\hat{S}(t)$"), 
                      ...) {
  estimativa_km %>% kable(caption=caption, col.names=col.names, ...)
}

# calcula estimativas
estimativas <- dados_raw %>% estimar_km(timeWeeks, delta)


```


```{r, echo=FALSE}
estimativas %>% tabela_km()

```


```{r, echo=FALSE}
plot_km <- function(
  estimativa_km, x_max=NULL, type="l", col=1, xlab="Tempo",
  ylab=expression(hat(S)),ylim = c(0,1),
  main = "Estimativa da função de sobrevivência por Kaplan-Meier", cex=.6, add=FALSE) {
  
  if(is.null(x_max)){
    x_max <- max(estimativa_km$t) * 1.10
  }
  
  x_km <- c(0, rep(estimativa_km$t, each=2), x_max)
  y_km <- c(1, 1, rep(estimativa_km$s_hat, each=2))
  
  if(add){
    lines(x_km, y_km, type=type, col=col, xlab=xlab, ylab=ylab, 
       ylim=ylim, main=main, cex=cex)
  }else{
    plot(x_km, y_km, type=type, col=col, xlab=xlab, ylab=ylab, 
       ylim=ylim, main=main, cex=cex)
  }
  
}

plot_km(estimativas)

```


(c) Coloque em um mesmo gráfico as duas curvas estimadas nos itens anteriores. Compare as curvas e comente.

```{r, echo=FALSE}
# QUESTAO 3c ----
plot_km(estimativas,main = "Estimativas da função de sobrevivência")
lines(x, y, type="l", col=4)
legend("topright",legend=c("Kaplan-Meier","Tábua de vida"),lty = c(1, 1),
       col = c(1,4), bty="n")


```

O método de Kaplan-Meier é o método da tábua de vida quando o o número de intervalos é o número de instantes únicos nos dados e os tamanhos dos intervalos são os tempos. Nota-se que o método de Kaplan-Meier melhora visualmente a estimativa da curva da função de sobrevivencia, principalmente após a semana 56, onde o número de censuras é maior e ficaram todas no último intervalo da tábua de vida todas




\includepdf[pages=1,scale=.8,pagecommand={\section{Questão 4}\label{pdf:q4}},linktodoc=true]{q4.pdf}
\includepdf[pages=2-,scale=.8,pagecommand={},linktodoc=true]{q4.pdf}


# Questão 5

Os dados mostrados a seguir representam o tempo até a ruptura de um tipo de isolante elétrico sujeito a uma tensão de estresse de 35 Kvolts. O teste consistiu em deixar 25 destes isolantes funcionando até que 15 deles falhassem (censura tipo II), obtendo-se os seguintes resultados (em minutos):
\begin{tabular}{cccccccc}
\hline \hline 0,19 & 0,78 & 0,96 & 1,31 & 2,78 & 3,16 & 4,67 & 4,85 \\
6,50 & 7,35 & 8,27 & 12,07 & 32,52 & 33,91 & 36,71 & \\
\hline \hline
\end{tabular}
Observe que 10 observações foram censuradas. Para este exercício, os cálculos podem ser feitos $\dot{a}$ mão ou com auxílio computacional, porém a ideia é não utilizar uma função pronta que calcule o que for pedido. Você deve usar uma planilha ou escrever o código que faça as contas no $\mathrm{R}$ ou outro software de sua preferência. A partir desses dados amostrais, deseja-se obter:


(a) a função de sobrevivência estimada por Kaplan-Meier;

```{r}
# QUESTAO 5a ----

# dados
dados <- tibble(
  t = c(0.19, 0.78, 0.96, 1.31, 2.78, 3.16, 4.67, 4.85, 
        6.50, 7.35, 8.27, 12.07, 32.52, 33.91, 36.71),
  delta = 1
  ) %>% 
  # censuras
  add_row(t= rep(36.71, 10), delta = 0)

estimativas <- estimar_km(dados, t, delta)


```

```{r, echo=FALSE}
estimativas %>% tabela_km()


```

```{r, echo=FALSE}
estimativas %>% plot_km()


```



(b) uma estimativa para o tempo mediano de vida deste tipo de isolante elétrico funcionando a essa tensão;

Para a vida mediana, nós vemos que $\hat{S}(12.07)=0.52$ e $\hat{S}(32.52)=0.48$, então o tempo mediano se encontra entre esses dois tempos. Por interpolação linear,

```{r}
# QUESTAO 5b ----

t0 = 12.07
t1 = 32.52
s0 = estimativas$s_hat[which(estimativas$t==t0)]
s1 = estimativas$s_hat[which(estimativas$t==t1)]

s=0.5
t_mediano = t0 + (t1-t0)*(s-s0)/(s1-s0)
t_mediano


```
encontramos um tempo de vida mediano igual a 22.295.



(c) uma estimativa (pontual e intervalar) para a fração de defeituosos esperada nos dois primeiros minutos de funcionamento;

Observemos que $t_0=1.31 < 2 < 2.78=t_1$. Com isso, usando interpolação linear,
```{r}
# QUESTAO 5c ----

t0 = 1.31
t1 = 2.78
s0 = estimativas$s_hat[which(estimativas$t==t0)]
s1 = estimativas$s_hat[which(estimativas$t==t1)]

# do item anterior:
#  t(s) = t0 + (t1-t0)*(s-s0)/(s1-s0)
# então s(t):
#  s = (t-t0)*(s1-s0)/(t1-t0) + s0
t=2
s_hat = (t-t0)*(s1-s0)/(t1-t0) + s0
c(s_hat, 1-s_hat)


```
Obtemos que $\hat{S}(2) \approx 0.82$, logo $1-\hat{S}(2)=0.18$ é uma estimativa pontual para a fração de defeituosos esperada nos dois primeiros minutos de funcionamento.

Uma estimativa intervalar pode ser obtida com

$$
\begin{aligned}
IC\left(S(t)); \gamma \right) &= \left( 
\hat{S}(t) - z_{\gamma / 2}\sqrt{\widehat{\operatorname{Var}}\left( \hat{S}(t)\right)};  
\hat{S}(t) + z_{\gamma / 2}\sqrt{\widehat{\operatorname{Var}}\left( \hat{S}(t)\right)}
\right) \\
\Rightarrow
IC\left(1-S(t)); \gamma \right) &= \left( 
1-\hat{S}(t) - z_{\gamma / 2}\sqrt{\widehat{\operatorname{Var}}\left( \hat{S}(t)\right)};  
1-\hat{S}(t) + z_{\gamma / 2}\sqrt{\widehat{\operatorname{Var}}\left( \hat{S}(t)\right)}
\right) \\
\end{aligned}
$$
onde 
$$
\widehat{\operatorname{Var}}(\hat{S}(t))=\left[\hat{S}(t)\right]^{2} \sum_{t_{(j)} \leq t} \frac{d_{j}}{\left.n_{j} ( n_{j}-d_{j}\right)}
$$

```{r}
var_hat <- estimativas %>% filter(t<2) %>% 
  summarise(
    a = (!!s_hat)^2 * sum(d/(Y*(Y-d))) 
  ) %>% pull()
var_hat


```
Obtemos que $\widehat{\operatorname{Var}}(\hat{S}(2))=\widehat{\operatorname{Var}}(1-\hat{S}(2)) \approx 0.0051$. Portanto, uma estimativa intervalar, com 90% de confiança, para a fração de defeituosos esperada nos dois primeiros minutos de funcionamento é
```{r}
z <-  qnorm(0.95) # 1 - (1-gamma)/2
round(c((1-s_hat) - z * sqrt(var_hat), (1-s_hat) + z * sqrt(var_hat)), 3)
```

$$
IC\left(1-S(2)); 90\% \right) = [0.061; 0.297]
$$




(d) o tempo necessário para 20% dos isolantes estarem fora de operação.

Observando a tabela, vemos que uma estimativa do tempo necessário para 20% dos isolantes estarem fora de operação é 2.78 quando $\hat{S}(t)=0.80$. Caso não estivesse na tabela, poderiamos obter por interpolação linear como nos outros itens.



# Questão 6
## 6.a

```{r, include = FALSE}
# QUESTAO 6 ----
# QUESTAO 6a ----
library(survival)
library(survminer)
q6 = read.table('data/Lista2_cancerLingua.txt')
colnames(q6) = c('perfil','tempo','delta')
q6_df = q6 %>% filter(perfil == 1)
```

Abaixo temos a saída com as estimativas de Kaplan-Meier.

```{r, echo = FALSE}
q6_km = survfit(Surv(tempo, delta) ~ 1,type = 'kaplan-meier', data = q6_df )
summary(q6_km)
```
Notemos então que $\hat{S}(60) = 0.654$, com erro padrão $0.066$.
Abaixo temos também o gráfico da função estimada de sobrevivência.

```{r, echo = F}
ggsurvplot(q6_km,q6_df, conf.int = FALSE)+
  labs(x="Tempo", y=expression(hat(S)(t)))
```

## 6.c

Abaixo temos a saída usando para os intervalos de confiança o método linear.

```{r, echo = F}
# QUESTAO 6c ----
library("km.ci")
out <- km.ci(q6_km, conf.level=0.95,  method="linear")
summary(out)
```

Como visto na saída, o intervalo de confiança linear para $\hat{S}(60)$ é $[0.5245 \ ; \ 0.783 ]$

## 6.e

```{r, echo = F}
# QUESTAO 6e ----
q6_km2<-survfit(Surv(q6$tempo, q6$delta)~1, conf.type='plain',type = "kaplan-meier")
out <- km.ci(q6_km2, conf.level=0.95,  method="epband") 
plot(q6_km2, xlab = "Tempo", ylab = "Sobrevivência estimada", ylim = c(0,1), xlim = c(0, 170))
lines(out, lty = 3, col = "red")
legend("topright", c("Kaplan-Meier", "IC Pontual", "Bandas de Confiança"),
       col = c("black", "black", "red"), lty = c(1,2,3), bty = "n")
```

Notemos então que a banda de confiança é sempre maior que o intervalo pontual.

## 6.f

```{r, echo = F}
# QUESTAO 6f ----
q6_km2<-survfit(Surv(q6$tempo, q6$delta)~1, conf.type='plain',type = "kaplan-meier")
library("km.ci")
out <- km.ci(q6_km2, conf.level=0.95,  method="hall-wellner") 
plot(q6_km2, xlab = "Tempo", ylab = "Sobrevivência estimada", ylim = c(0,1), xlim = c(0, 170))
lines(out, lty = 3, col = "red")
legend("topright", c("Kaplan-Meier", "IC Pontual", "Hall-Wellner"),
       col = c("black", "black", "red"), lty = c(1,2,3), bty = "n")
```

Notemos então que a banda de confiança de Hall-Wellner é sempre maior que o intervalo pontual.

```{r}
library(survival)
library(survminer)
q6 = read.table('data/Lista2_cancerLingua.txt')
colnames(q6) = c('perfil','tempo','delta')
q6_df = q6 %>% filter(perfil == 1)
```

# Questão 7

```{r}
# QUESTAO 7 ----

dados_raw <- readr::read_csv('data/pharmacoSmoking.csv')

dados_grp <- dados_raw %>% group_by(grp) 
lst_dados <- dados_grp %>% group_split()
names(lst_dados) <- group_keys(dados_grp) %>% pull()

# calcula estimativas para cada grupo
lst_estimativas <- lst_dados %>% purrr::map(~estimar_km(., ttr, relapse)  )


```

a) Obtenha as curvas de Kaplan-Meier dos dois tratamentos;

```{r}
tabela_km(lst_estimativas[["combination"]], 
          caption="Estimativas de Kaplan-Meier para combination.")
tabela_km(lst_estimativas[["patchOnly"]], 
          caption="Estimativas de Kaplan-Meier para patchOnly.")

```

```{r}

plot_km(lst_estimativas[["combination"]])
plot_km(lst_estimativas[["patchOnly"]], col=2, add=T)

legend("topright",legend=c("Combination","PatchOnly"),lty = c(1, 1),
       col = c(1,2), bty="n")

```
As estimativas de Kaplan-Meier são bem diferentes para os dois grupos como podemos notar pelas tabelas e gráfico.



(b) Compare os tratamentos utilizando o teste de log-rank e também utilizando diferentes ponderações (escolha pelo menos três diferentes);

Para esse item, vamos usar os pacotes `survival` para o modelo de sobrevivencia e `survminer` para realizar os testes. Realizamos o teste de log-rank e também usando diferentes ponderações: Gehan-Breslow (Wilcoxon generalizado), Peto-Peto e Fleming-Harrington(p=1, q=1).

```{r}
# QUESTAO 7b ----

# install.packages(c("survival", "survminer"))
library(survival)
library(survminer)

# modelo
sfit <- survfit(Surv(ttr, relapse)~grp, data=dados_raw)

bind_rows(
  # teste de log rank
  surv_pvalue(sfit, method = "log-rank"),
  
  # usando Gehan-Breslow (Wilcoxon generalizado)
  surv_pvalue(sfit, method = "gehan-breslow"),
  
  # usando  Peto-Peto
  surv_pvalue(sfit, method = "S1"),
  
  # usando Fleming-Harrington(p=1, q=1)
  surv_pvalue(sfit, method = "FH_p=1_q=1"),
) %>% 
  dplyr::relocate(method) %>% 
  dplyr::select(-pval.txt)


```

Em todos os testes o valor p deu significativo a um nível de 5%. Com isso, rejeitamos a hipótese nula de de que não existe diferença na curva de sobrevivência dos dois grupos.


(c) Compare as curvas de Kaplan-Meier utilizando o teste de log-rank, estratificado por situação de trabalho (variável employment) e discuta os resultados.

```{r, out.width="70%"}
# QUESTAO 7c ----

# modelo
sfit <- survfit(Surv(ttr, relapse)~grp+strata(employment), data=dados_raw)

ggsurvplot(sfit,dados_raw)+
  labs(x="Tempo", y=expression(hat(S)(t)))

```

Fizemos o teste de log-rank do modelo estratificado por `employment`:
```{r}
survdiff(Surv(ttr, relapse)~grp+strata(employment), data=dados_raw)
```
Obtivemos um valor p de 0.003, com isso, a um nível de 5%, rejeitamos a hipótese nula de diferença nas curvas de sobrevivência entre os grupos, controlando pela situação de trabalho.




\includepdf[pages=1,scale=.8,pagecommand={\section{Questão 8}\label{pdf:q8}},linktodoc=true]{q8.pdf}


# Código Completo

```{r ref.label=knitr::all_labels(), echo=TRUE, eval=FALSE}
```
