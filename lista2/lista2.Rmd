---
title: "MAE0514 - Introducão a Análise de Sobrevivência - Lista 2"
author: |
  | Bruno de Castro Paul Schultze\thanks{Número USP: 10736862}
  | Rubens Santos Andrade Filho\thanks{Número USP: 10370336}
date: "`r stringr::str_to_sentence(format(Sys.time(), '%B de %Y'))`"
lang: pt-BR
header-includes:
  # - \usepackage[brazilian]{babel} # ja usando lang: pt-BR
  - \usepackage{float}
  - \usepackage{amsmath}
  - \usepackage{amsthm}
  - \floatplacement{figure}{H}
  - \usepackage{indentfirst}
  - \setlength{\parindent}{4em}
  - \setlength{\parskip}{1em}
  - \usepackage{booktabs}
  - \usepackage{dcolumn}
  - \usepackage{bm}
  - \usepackage{titling}
  - \thanksmarkseries{arabic} % \thanks footnotes com numeros
  - \usepackage[bottom]{footmisc} % corrige posição footnotes
  - \usepackage{pdfpages}
  - \usepackage{tocloft}
  - \renewcommand{\cftsecleader}{\cftdotfill{\cftdotsep}}
  - \usepackage{amssymb}
  - \renewcommand\qedsymbol{$\blacksquare$}
  - \usepackage{pdfpages}
  - \usepackage{cleveref}
  - \usepackage{threeparttable}
output:
  pdf_document: 
    fig_caption: yes
    number_sections: no
    toc: true
    toc_depth: 3
---

\pagebreak

\newcommand\invisiblesection[1]{%
  \refstepcounter{section}%
  \addcontentsline{toc}{section}{#1}%
  \sectionmark{#1}}

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, 
                      # fig.dim = c(5,5),
                      # out.height = '40%',
                      # fig.align = 'center',
                      message=FALSE
                      )

library(tidyverse)
library(ggplot2)
library(knitr)
library(readr)
library(dplyr)
```

\clearpage

# Questão 1


a)

A variável do estudo é o tempo compreendido da exposição a um material cancerígeno até o desenvolvimento do tumor de um tamanho determinado nos ratos. Nesse caso, a origem é a exposição a um material cancerígeno e o evento de interesse é o desenvolvimento do tumor de um tamanho determinado.

b)

Para os rato A, B e C foram observados os tempos de falha, isto é, os tempos até os ratos desenvolverem o tumor de determinado tamanho. 

Para o rato D foi observado uma censura aleatória à direita na vigésima semana, sua morte. Até a semana 20 o rato não tinha desenvolvido o tumor de um tamanho determinado.

Para os ratos E e F foram observados censuras à direita do tipo I na semana 30 por ser a do estudo. Entretanto no enunciado não está claro se todos os ratos foram expostos ao material cancerígeno ao mesmo tempo para dizermos se a censura é generalizada ou não.


# Questão 2


# Questão 3

Em um estudo clínico realizado com pacientes com câncer gástrico avançado (com metástase linfodonal), uma quimioterapia com Xeloda (capecipabina) e oxaliplatina foi administrada antes da cirurgia de 48 pacientes. Nesse tipo de ensaio clínico, é de interesse estudar e avaliar o tempo livre da doença, que é o tempo que o paciente fica bem, vivo e sem a doença. Assim, um dos objetivos é estudar o tempo decorrido entre o início do tratamento e óbito ou progressão da doença (o que ocorrer primeiro). Os dados do tempo livre da doença (em semanas) dos 48 pacientes estão disponíveis no arquivo `Lista2-Xelox.csv`, sendo que a variável delta é codificada como sendo 1 se o evento ocorreu e 0 se a observação é censurada.

(a) Calculamos o estimador da tábua de vida, considerando as seguintes faixas de tempo:

\begin{tabular}{|ll|}
\hline Faixa 1: & 8 semanas (inclusive) ou menos \\
Faixa 2: & de 8 a 16 semanas (inclusive) \\
Faixa 3: & de 16 a 24 semanas (inclusive) \\
Faixa 4: & de 24 a 32 semanas (inclusive) \\
Faixa 5: & de 32 a 44 semanas (inclusive) \\
Faixa 6: & de 44 a 56 semanas (inclusive) \\
Faixa 7: & mais de 56 semanas \\
\hline
\end{tabular}

Dessa forma, consideramos os intervalos fechados à direita.

```{r}
# QUESTAO 3a ----

dados_raw <- readr::read_csv2('data/Lista2-Xelox.csv')

# limites dos intervalos
breaks <- c(0,8,16,24,32,44,56, Inf)

tabua <- dados_raw %>% 
  mutate(
    # define as faixas
    intervalo = cut(timeWeeks, breaks=breaks, right=TRUE, include.lowest = T),
    i = as.integer(intervalo)
  ) %>% 
  group_by(intervalo, i) %>% 
  summarise(
    # numero de falhas no intervalo
    d = sum(delta),
    # numero de censuras no intervalo
    w = sum(1-delta)
  ) %>% 
  ungroup() %>% 
  mutate(
    # numero de obs em risco, que nao falharam até o fim do intervalo anterior
    n_estrela = sum(d+w) - cumsum(d+w) +w+d,
    # corrigindo o numero de ind. em risco
    n = n_estrela - w/2,
    # prop. de falhas no intervalo
    q_hat = d/n,
    # na tabua de vida, a estimativa de S do 1o intervalo = 1
    # depois o produtorio acumulado dos p_i
    s_hat = c(1, cumprod(1 - q_hat)[-n()])
  )


```


```{r, echo=FALSE}
tabua %>%
  kable(
    caption = "Estimativas da tábua de vida.", 
    col.names = c(
      "Semanas","$i$","$d_i$","$w_i$",
      "$n*$","$n$", 
      "$q_i$",
      "$\\hat{S}(t)$"))


```

```{r, echo=FALSE}
x = rep(breaks, each=2)[2:15]
x[length(x)] <- 100 # substitui infinito
y = rep(tabua$s_hat, each=2)

plot(x, y, type="l", col=4, xlab="Semanas", ylab=expression(hat(S)),ylim = c(0,1),
     main = "Estimativa da função de sobrevivência pela tábua de vida", cex=.6)


```


Chama a atenção o fato da estimativa da função de sobrevivência não se aproximar de 0 à medida que aumentam o número de semanas. Isso acontece principalmente devido às 11 observações censuradas que ficaram no último intervalo, isto é, temos menos muito menos informação a respeito das falhas nesse intervalo.



(b) Calcule o estimador Kaplan-Meier para os dados (você pode utilizar um software).

```{r, echo=FALSE}
# QUESTAO 3b ----
kmeier <- dados_raw %>%
  group_by(t=timeWeeks) %>%
  # numero de eventos e censuras em cada t
  summarise(d = sum(delta), w=sum(1-delta)) %>% 
  ungroup() %>% 
  mutate(
    # numero de individuos vivos até antes de cada instante t
    Y = sum(d+w) - (cumsum(d+w) - (d+w)),
    # estimate of the conditional probability that an individual who survives 
    # to just prior to time ti experiences the event at time ti
    q = d/Y,
    # estimate of surv function
    s_hat = cumprod(1 - q)
  ) %>% 
  filter(d!=0)


```


```{r, echo=FALSE}
kmeier %>% 
  kable(
    caption = "Estimativas de Kaplan-Meier.", 
    col.names = c(
      "Semana","$d_i$","$w_i$",
      "$Y_i$", 
      "$q_i=d_i/Y_i$", 
      "$\\hat{S}(t)$"))


```


```{r, echo=FALSE}
x_km <- c(0, rep(kmeier$t, each=2), 100)
y_km <- c(1, 1, rep(kmeier$s_hat, each=2))
plot(x_km, y_km, type="l", col=1, xlab="Semanas", ylab=expression(hat(S)),ylim = c(0,1),
     main = "Estimativa da função de sobrevivência por Kaplan-Meier", cex=.6)


```


(c) Coloque em um mesmo gráfico as duas curvas estimadas nos itens anteriores. Compare as curvas e comente.

```{r, echo=FALSE}
# QUESTAO 3c ----
plot(x_km, y_km, type="l", col=1, xlab="Semanas", ylab=expression(hat(S)),ylim = c(0,1),
     main = "Estimativas da função de sobrevivência", cex=.6)
lines(x, y, type="l", col=4)
legend("topright",legend=c("Kaplan-Meier","Tábua de vida"),lty = c(1, 1),
       col = c(1,4), bty="n")


```

O método de Kaplan-Meier é o método da tábua de vida quando o o número de intervalos é o número de instantes únicos nos dados e os tamanhos dos intervalos são os tempos. Nota-se que o método de Kaplan-Meier melhora visualmente a estimativa da curva da função de sobrevivencia, principalmente após a semana 56, onde o número de censuras é maior e ficaram todas no último intervalo da tábua de vida todas



# Questão 4


# Questão 5

Os dados mostrados a seguir representam o tempo até a ruptura de um tipo de isolante elétrico sujeito a uma tensão de estresse de 35 Kvolts. O teste consistiu em deixar 25 destes isolantes funcionando até que 15 deles falhassem (censura tipo II), obtendo-se os seguintes resultados (em minutos):
\begin{tabular}{cccccccc}
\hline \hline 0,19 & 0,78 & 0,96 & 1,31 & 2,78 & 3,16 & 4,67 & 4,85 \\
6,50 & 7,35 & 8,27 & 12,07 & 32,52 & 33,91 & 36,71 & \\
\hline \hline
\end{tabular}
Observe que 10 observações foram censuradas. Para este exercício, os cálculos podem ser feitos $\dot{a}$ mão ou com auxílio computacional, porém a ideia é não utilizar uma função pronta que calcule o que for pedido. Você deve usar uma planilha ou escrever o código que faça as contas no $\mathrm{R}$ ou outro software de sua preferência. A partir desses dados amostrais, deseja-se obter:


(a) a função de sobrevivência estimada por Kaplan-Meier;

```{r}
# QUESTAO 5a

dados <- tibble(
  t = c(0.19, 0.78, 0.96, 1.31, 2.78, 3.16, 4.67, 4.85, 
        6.50, 7.35, 8.27, 12.07, 32.52, 33.91, 36.71),
  delta = 1
  ) %>% 
  add_row(t= rep(36.71, 10), delta = 0)

kmeier <- dados %>%
  group_by(t) %>%
  # numero de eventos e censuras em cada t
  summarise(d = sum(delta), w=sum(1-delta)) %>% 
  ungroup() %>% 
  mutate(
    # numero de individuos vivos até antes de cada instante t
    Y = sum(d+w) - (cumsum(d+w) - (d+w)),
    # estimate of the conditional probability that an individual who survives 
    # to just prior to time ti experiences the event at time ti
    q = d/Y,
    # estimate of surv function
    s_hat = cumprod(1 - q)
  ) %>% 
  filter(d!=0)

```

```{r, echo=FALSE}
kmeier %>% 
  kable(
    caption = "Estimativas de Kaplan-Meier.", 
    col.names = c(
      "Tempo","$d_i$","$w_i$",
      "$Y_i$", 
      "$q_i=d_i/Y_i$", 
      "$\\hat{S}(t)$"))


```


(b) uma estimativa para o tempo mediano de vida deste tipo de isolante elétrico funcionando a essa tensão;

Para a vida mediana, nós vemos que $\hat{S}(12,07)=0,52$ e $\hat{S}(32,52)=0,48$, entao o tempo mediano se encontra entre esses dois tempos. Por interpolação linear

```{r}
# QUESTAO 5b

t0 = 12.07
t1 = 32.52
s0 = kmeier$s_hat[which(kmeier$t==t0)]
s1 = kmeier$s_hat[which(kmeier$t==t1)]

s=0.5
t_mediano = t0 + (t1-t0)*(s-s0)/(s1-s0)
t_mediano
```
Encontramos um tempo de vida mediano igual a 22,295.

(c) uma estimativa (pontual e intervalar) para a fração de defeituosos esperada nos dois primeiros minutos de funcionamento;

```{r}



```



(d) o tempo necessário para $20 \%$ dos isolantes estarem fora de operação.


# Questão 6


# Questão 7


# Questão 8


# Código Completo

```{r ref.label=knitr::all_labels(), echo=TRUE, eval=FALSE}
```
