---
title: "MAE0514 - Introducão a Análise de Sobrevivência - Lista 1"
author: |
  | Bruno de Castro Paul Schultze\thanks{Número USP: 10736862}
  | Rubens Santos Andrade Filho\thanks{Número USP: 10370336}
date: "`r stringr::str_to_sentence(format(Sys.time(), '%B de %Y'))`"
lang: pt-BR
header-includes:
  # - \usepackage[brazilian]{babel} # ja usando lang: pt-BR
  - \usepackage{float}
  - \usepackage{amsmath}
  - \usepackage{amsthm}
  - \floatplacement{figure}{H}
  - \usepackage{indentfirst}
  - \setlength{\parindent}{4em}
  - \setlength{\parskip}{1em}
  - \usepackage{booktabs}
  - \usepackage{dcolumn}
  - \usepackage{bm}
  - \usepackage{titling}
  - \thanksmarkseries{arabic} % \thanks footnotes com numeros
  - \usepackage[bottom]{footmisc} % corrige posição footnotes
  - \usepackage{pdfpages}
  - \usepackage{tocloft}
  - \renewcommand{\cftsecleader}{\cftdotfill{\cftdotsep}}
  - \usepackage{amssymb}
  - \renewcommand\qedsymbol{$\blacksquare$}
  - \usepackage{pdfpages}
  - \usepackage{cleveref}
  - \usepackage{threeparttable}
output:
  pdf_document: 
    fig_caption: yes
    number_sections: no
    toc: true
    toc_depth: 3
---

\pagebreak

\newcommand\invisiblesection[1]{%
  \refstepcounter{section}%
  \addcontentsline{toc}{section}{#1}%
  \sectionmark{#1}}

```{r setup, include=FALSE}

knitr::opts_chunk$set(warning=FALSE, 
                      # fig.dim = c(5,5),
                      # out.height = '40%',
                      # fig.align = 'center',
                      message=FALSE
                      )

library(tidyverse)
library(ggplot2)
library(knitr)
library(extRemes) # bandas de confiança nos qqplot
```

\clearpage

\invisiblesection{Exercício 1}
\includepdf[pages=1]{q1_q4.pdf}

\invisiblesection{Exercício 2}
\includepdf[pages=2]{q1_q4.pdf}

\invisiblesection{Exercício 3}
\includepdf[pages=3]{q1_q4.pdf}

\invisiblesection{Exercício 4}
\includepdf[pages=4-]{q1_q4.pdf}

<!-- \includepdf[pages=1,scale=.8,pagecommand={\section{Questões 1 a 4}\label{pdf:q1_q4}},linktodoc=true]{q1_q4.pdf} -->
<!-- \includepdf[pages=2-,scale=.8,pagecommand={},linktodoc=true]{q1_q4.pdf} -->

# Questão 5

```{r, include=FALSE}

#### CÓDIGOS EXERCÍCIO 5


```



## a)

Temos que:
$$Y_A = \ln(T_A) = 2 + 2W$$
$$Y_B = \ln(T_B) = 2,5 + 2W$$
Assim, sendo:
$$W = \frac{\ln(T_A) - 2}{2}$$
$$T_A = \exp\{2 + 2W\}$$

Podemos então escrever:

$$S_A(t) = P(T_A > t) = P(\exp\{2 + 2W\} > t) = P(W > \frac{ln(T_A) - 2}{2})$$
Então:
$$S_A(t) = S_W(\frac{ln(T_A) - 2}{2}) = \exp\{- e^{\frac{ln(T_A) - 2}{2}}\}$$
$$\leftrightarrow S_A(t) = \exp\{- \sqrt{t} . e^{-1}\}$$
Analogamente:
$$S_B(t) = \exp\{- \sqrt{t} . e^{- \frac{2,5}{2}}\}$$

## b)
Agora temos simplesmente que calcular $S_A(t)$ e $S_B(t)$ para t igual a 6, 12, 24 e 60 (pois t está em meses).
Assim:

```{r, echo = T}
tibble(
  t = c(6, 12, 24, 60),
  S_A = exp(- (sqrt(t) * exp(-1))),
  S_B = exp(- (sqrt(t) * exp(-(2.5/2))))
) %>% 
  kable(col.names = c('t', '$S_A(t)$', '$S_B(t)$'), digits = 3) 
```

Podemos notar então que para todo t testado, $S_B(t) > S_A(t)$.

## c)
A partir da questão 1 podemos tirar a relação:
$$\alpha(t) = \frac{d}{dt}[- ln \ S(t)]$$

Assim:

$$\alpha_A(t) = \frac{d}{dt}(\sqrt{t} . e^{-1}) = \frac{1}{2e\sqrt{t}}$$
$$\alpha_A(t) = \frac{d}{dt}(\sqrt{t} . e^{- \frac{2,5}{2}}) = \frac{1}{2e^{\frac{2,5}{2}}\sqrt{t}}$$

```{r}
tibble(
  t = c(6, 12, 24, 60),
  alp_a = 1/(2 * exp(1) * sqrt(t)),
  alp_b = 1/(2 * exp(2.5/2) * sqrt(t)),
  razao = alp_a/alp_b
) %>% 
  kable(col.names = c('t', '$\\alpha_A(t)$', '$\\alpha_B(t)$', 
                      '$\\frac{\\alpha_A}{\\alpha_B}$'), 
        digits = 3)
```

Notemos então que a razão é a mesma para todo t analisado.

## d)

Se W tem uma distribuição normal padrão, sendo $\Phi(w)$ a função de distribuição acumulada, seguindo os mesmos passos de 5.a temos que:
$$1 - F_A(t) = 1 - \Phi(\frac{ln(t) - 2}{2})$$
$$\therefore S_A(t) =  1 - \Phi(c)$$
Analogamente:
$$ S_B(t) = 1 - \Phi(\frac{ln(t) - 2,5}{2})$$

## e)

A função _pnorm(x)_ nos dá $\Phi(x)$. 

```{r, echo = T}

tibble(
  t = c(6, 12, 24, 60),
  S_A = 1 - pnorm((log(t) - 2)/2),
  S_B = 1 - pnorm((log(t) - 2.5)/2)
   ) %>% kable(col.names = c('t', '$S_A(t)$', '$S_B(t)$'), digits = 3) 
```

Notemos que, novamente, $S_B(t) > S_A(t)$ para todos os t analisados.

## f)

Para facilitar, ao inves da relação usada em 5.c, vamos usar a relação:
$$\alpha(t) = \frac{f(t)}{S(t)}$$
No livro "Introduction to the Theory of Statistics", de Mood, Graybill e Boes, aprendemos que se $Y = g(X)$ então (dadas algumas condições generosas, que são respeitadas aqui):
$$f_Y(y) = |\frac{d}{dy}g^{-1}(y)|f_x(g^{-1}(y))$$
Assim:
$$f_A(t) = |\frac{d}{dt} \frac{ln(t) - 2}{2}| \ .\ \Phi(\frac{ln(t) - 2}{2})$$
$$\therefore f_A(t) =  \frac{1}{2t}\ f_W(\frac{ln(t) - 2}{2})$$

Analogamente:
$$f_B(t) =  \frac{1}{2t}\ f_W(\frac{ln(t) - 2,5}{2})$$

Assim, conseguimos $\alpha(t)$ usando a relação já mostrada aqui:
$$\alpha(t) = \frac{f(t)}{S(t)}$$

Dessa forma, sabendo que _dnorm(x)_ é $f_W(x)$ tendo W uma distribuição normal padrão:

```{r}
tibble(
  t = c(6, 12, 24, 60),
  alp_a = ((1/(2*t))*(dnorm((log(t) - 2)/(2))))/(1 - pnorm((log(t) - 2)/2)),
  alp_b = ((1/(2*t))*(dnorm((log(t) - 2.5)/(2))))/(1 - pnorm((log(t) - 2.5)/2)),
  razao = alp_a/alp_b
   ) %>% kable(col.names = c('t', '$\\alpha_A(t)$', 
                             '$\\alpha_B(t)$', 
                             '$\\frac{\\alpha_A}{\\alpha_B}$'), digits = 3)
```

Portanto, diferentemente de antes, a razão entre as funções de taxa não é mais igual para os diferentes t testados, $\alpha_A(t) > \alpha_B(t)$ e a função decresce quando t aumenta.





# Exercício 6

```{r, include=FALSE}


#### CÓDIGOS EXERCÍCIO 6

```


Consideremos a distribuição Weibull, com função de sobrevivência dada por 
$$
S(t)=\exp \left\{-\lambda t^{\rho}\right\}, t \geq 0
$$

Dada a função de sobrevivência, obtemos a função de densidade de probabilidade:
$$
f(t) = -\frac{d}{dt}\left[ S(t) \right] 
= -\frac{d}{dt}\left(e^{-\lambda t^{\rho}}\right)
= \lambda\rho t^{\rho-1}e^{-\lambda t^{\rho}}
$$

E a taxa de falha:
$$
\alpha(t) = \frac{f(t)}{S(t)} = 
\frac{\lambda\rho t^{\rho-1}e^{-\lambda t^{\rho}}}{e^{-\lambda t^{\rho}}}
=\lambda\rho t^{\rho-1}
$$

Utilizando o *software* `R`, construímos gráficos da função de taxa de falha da distribuição Weibull, variando os valores dos parâmetros $\lambda$ e $\rho$. Consideramos 6 combinações diferentes de valores de $\lambda$ e $\rho$: dois valores diferentes de $\lambda$ (1 e 2) e três valores diferentes de $\rho$ (0.5, 1 e 1.5). Mostramos também nos gráficos as respectivas funções de sobrevivência.

```{r}
# dados lambda e rho, cria função de taxa de falha
alpha_factory <- function(lambda, rho){
  function(t) ifelse(t>0, lambda * rho * t^(rho-1), NA)
}

# dados lambda e rho, cria função de sobrevivencia
s_factory <- function(lambda, rho){
  function(t) ifelse(t>0, exp(-lambda * t^rho), 1)
}


# parametros
lambda = c(1,2)
rho = c(1/2,1,3/2)
ts = seq(0, 2, length.out=200)

# cria dados e calcula taxas de falhas e tempos de sobrevivencia
# para cada combinação de parametros
df <- expand_grid(lambda, rho) %>% 
  purrr::pmap_dfr(
    function(lambda, rho) {
      # cria funcoes de taxa de falha e sobrevivencia
      alpha <- alpha_factory(lambda, rho)
      s <- s_factory(lambda, rho)
      # retorna df com taxas de falha e sobrevicencia
      tibble(lambda, rho, t=ts,
        alpha = alpha(ts), s = s(ts)
      )}
    )
```

```{r,echo=FALSE,fig.align='center',fig.asp=1, out.height = NULL}
# grafico da funcao de taxa de falha

# para transf. do axis secundário
coef <- max(df$alpha,na.rm = T)

df %>% 
  ggplot(aes(x=t))+
  geom_line(aes(y=alpha/coef, color='alpha'),size=1)+
  geom_line(aes(y=s, color="S"),size=1)+
  facet_grid(vars(rho),vars(lambda), scales = 'free_y', 
             labeller = function(x) label_parsed(label_both(x)))+
  # ylab("")+
  ylim(0,1)+
  scale_color_discrete(
    name="",labels=c("S"=expression(S(t)), "alpha"=expression(alpha(t))))+
  scale_y_continuous(
    name = expression(S(t)),
    # Add a second axis and specify its features
    sec.axis = sec_axis(~.*coef, name=expression(alpha(t)))
  ) + 
  theme_classic() +
  theme(
    legend.position = "bottom", 
    strip.background = element_blank(),
    axis.text.y = element_text(angle = 0),
    axis.title.y.left = element_text(vjust = 0.5,angle = 0),
    axis.title.y.right = element_text(vjust = 0.5,angle = 0),
    strip.text.y = element_text(angle = 0),
    ) +
  NULL
  
  
```

# Exercício 7

Consideramos a distribuição Weibull do exercício anterior e definimos $\lambda=2$ e $\rho=1.5$ utilizadas. Utilizando o *software* `R`, geramos uma amostra de tamanho $n=100$ com a distribuição Weibull escolhida.

No `R`, a distribuição Weibull é parametrizada em termos de uma parâmetro de localização $a$ e escala $b$ :

$$
f(t) = \frac{a}{b} \left(\frac{t}{b}\right)^{a-1} e^{-\left(\frac{t}{b}\right)^a}
$$

Reescrevendo, obtemos $a$ e $b$ em termos $\lambda$ e $\rho$ :

$$
f(t) = \frac{a}{b} \left(\frac{t}{b}\right)^{a-1} e^{-\left(\frac{t}{b}\right)^a}
 = a \frac{1}{b^{a}} t^{a-1} e^{- \frac{1}{b^{a}} t^a}
 = \rho \lambda t^{\rho-1}e^{-\lambda t^{\rho}}\\
\Rightarrow a=\rho,\quad\quad \lambda = \frac{1}{b^{a}} \Rightarrow b = \frac{1}{\lambda^{ \frac{1}{a} }}
$$
```{r, echo=TRUE}
# parametros
lambda <- 2
rho <- 3/2

# semente do gerador de numeros aleatorios
set.seed(1)

# amostra aleatória da distribuição
n <- 100
x <- rweibull(n, shape=rho, scale = 1/lambda^(1/rho))
```

## a) 

Obtemos um boxplot dos dados e um histograma (com a curva da densidade teórica também no gráfico). Obtemos também a curva de sobrevivência empírica dos dados e colocamos num mesmo gráfico a curva empírica e a curva teórica utilizada para gerar os gráficos.

```{r, echo=FALSE, fig.align='center', out.width="80%"}
# boxplot
boxplot(x, ylab="", main="Boxplot", horizontal = TRUE,  ylim=c(0, 1.6), frame=FALSE)

# histograma + fdp
hist(x,freq = FALSE, main="Histograma", ylab="Densidade")
fdp <- function(x) dweibull(x, shape=rho, scale = 1/lambda^(1/rho))
curve(fdp, add=TRUE)

# f. empirica de distribuição, sobrevivencia e teorica de sobrevivencia
fed <- ecdf(x)
fes <- function(x) 1 - fed(x)
fts <- function(x) pweibull(x, shape=rho, scale = 1/lambda^(1/rho), lower.tail=FALSE)

sort(x) %>% plot(fes(.), type="s", ylab="P(X>x)", xlab="x")
curve(fts, add=TRUE, col="red", lwd=2)
```

## b)

Fizemos um gráfico de quantis (*QQPlot*) comparando os quantis empíricos com os quantis teóricos da distribuição Weibull utilizada para gerar os dados.

```{r, echo=FALSE, fig.align='center', out.width="80%"}
# função teorica quantilica
dfp <- function(p) qweibull(p, shape=rho, scale = 1/lambda^(1/rho))

qqplot(dfp(ppoints(x)), x, xlab = "Theoretical Distribution",
       ylab = "Sample Distribution",
       main=paste("QQPlot, n =", n), regress = FALSE)
```


## c) 

Padronizamos os dados (subtraindo a média amostral e dividindo pelo desvio padrão amostral) e fizemos um gráfico de quantis (*QQPlot*) comparando os quantis empíricos da variável padronizada com os da normal padrão.

```{r, echo=FALSE, fig.align='center', out.width="80%"}
sx <- (x - mean(x))/sd(x)
qqnorm(sx)
qqline(sx)
```

O gráfico Normal QQPlot mostra no eixo y os quantis da amostra padronizada, isto é, as estatísticas de ordem da amostra padronizada e, no eixo x, os quantis teóricos de uma normal padrão. Se a amostra é retirada de uma população normal, os pontos deveriam cair próximos da linha diagonal. Nota-se pelo gráfico que os pontos desviam-se um pouco da linha nas extremidades, entretanto um desvio um pouco maior nas extremidades é esperado. Com isso, apesar de saber de qual distribuição foi tirada a amostra, pelo gráfico não descarta-se a adequabilidade da distribuição normal aos dados.


## d) 

Repetimos os itens (b) e (c) para $n=40, n=300$ e $n=1200$.



```{r, echo=FALSE, fig.asp=1, out.width="50%"}

gerar_graficos <- function(n){
  # amostra aleatória da distribuição
  x <- rweibull(n, shape=rho, scale = 1/lambda^(1/rho))
  
  # b)
  # função teorica quantilica
  dfp <- function(p) qweibull(p, shape=rho, scale = 1/lambda^(1/rho))
  qqplot(dfp(ppoints(n)), x, xlab = "Theoretical Distribution",
         ylab = "Sample Distribution",
         main=paste("QQPlot, n =", n), regress = FALSE)
  
  # c)
  sx <- (x - mean(x))/sd(x)
  qqnorm(sx, main=paste("Normal QQPlot, n =", n))
  qqline(sx)
}

gerar_graficos(n = 40)
```


```{r, echo=FALSE, fig.asp=1, out.width="50%"}
gerar_graficos(n = 300)
```


```{r, echo=FALSE, fig.asp=1, out.width="50%"}
gerar_graficos(n = 1200)
```


Nota-se pelos gráficos que  conforme n cresce, cresce também a inadequabilidade dos dados à distribuição normal ($n=300$ e $n=1200$), ao passo que cresce a adequabilidade dos dados à distribuição Weibull, como era esperado.


# Código Completo

```{r ref.label=knitr::all_labels(), echo=TRUE, eval=FALSE}
```

