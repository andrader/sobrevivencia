---
title: "MAE0514 - Introducão a Análise de Sobrevivência - Lista 4"
author: |
  | Bruno de Castro Paul Schultze\thanks{Número USP: 10736862}
  | Rubens Santos Andrade Filho\thanks{Número USP: 10370336}
date: "`r stringr::str_to_sentence(format(Sys.time(), '%B de %Y'))`"
lang: pt-BR
header-includes:
  # - \usepackage[brazilian]{babel} # ja usando lang: pt-BR
  - \usepackage{float}
  - \usepackage{amsmath}
  - \usepackage{amsthm}
  - \floatplacement{figure}{H}
  - \usepackage{indentfirst}
  - \setlength{\parindent}{4em}
  - \setlength{\parskip}{1em}
  - \usepackage{booktabs}
  - \usepackage{dcolumn}
  - \usepackage{bm}
  - \usepackage{titling}
  - \thanksmarkseries{arabic} % \thanks footnotes com numeros
  - \usepackage[bottom]{footmisc} % corrige posição footnotes
  - \usepackage{grffile}
  - \usepackage{pdfpages}
  - \usepackage{tocloft}
  - \renewcommand{\cftsecleader}{\cftdotfill{\cftdotsep}}
  - \usepackage{amssymb}
  - \renewcommand\qedsymbol{$\blacksquare$}
  - \usepackage{pdfpages}
  - \usepackage{cleveref}
  - \usepackage{threeparttable}
output:
  pdf_document: 
    fig_caption: yes
    number_sections: no
    toc: true
    toc_depth: 3
---

\pagebreak


```{r setup, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, 
                      # fig.dim = c(5,5),
                      # out.height = '40%',
                      # fig.align = 'center',
                      message=FALSE
                      )

library(tidyverse)
library(ggplot2)
library(knitr)
library(readr)
library(dplyr)


```


# Questão 1

Breve resumo do artigo:

(ii) Fabiani, M., Ramigni, M., Gobbetto, V., Mateo-Urdiales, A., Pezzotti, P., Piovesan, C. (2021). Effectiveness of the Comirnaty (BNT162b2, BioNTech/Pfizer) vaccine in preventing SARS-CoV-2 infection among healthcare workers, Treviso province, Veneto region, Italy, 27 December 2020 to 24 March 2021, _Euro Surveillance_, 26(17).

O objetivo do artigo foi estimar a eficácia da vacina Comirnaty (BNT162b2, BioNTech/Pfizer) na prevenção de infecção por SARS-CoV-2. Para isso, foi realizado um estudo de coorte retrospectivo no qual foram utilizados dados demográficos, características profissionais e datas de vacinção de 6.423 trabalhadores da área de saúde empregados na unidade local de saúde da província de Treviso em Veneto na Itália.

Primeiro, foram realizadas curvas de Kaplan-Meier para o tempo desde o inicio da campanha de vacinação até a infecção pelo vírus ou o fim do estudo para indivíduos não vacinados, que tomaram a primeira dose e ambas as doses da vacina. As curvas mostram que os pacientes que tomaram ambas as doses, e depois os que tomaram a primeira dose, apresentaram consistentemente uma menor probabilidade acumulada de infecção.

Também foi feita uma análise para o número de dias desde a administração da vacina para medir a duração do acompanhamento. A eficácia da vacina em diferentes intervalos de tempo foi estimada usando um modelo multivariável de risco proporcional de Cox, incluindo sexo, faixa etária, categoria profissional, contexto de trabalho e semana inicial de exposição como covariáveis.

A análise sugeriu que a vacina Comirnaty teve uma alta eficácia na prevenção da infecção por SARS-CoV-2 em HCW durante os intervalos de tempo após a administração em que a proteção pode ser esperada.


# Questão 2

## 2.a

# Questão 3

# Questão 4

## a)

```{r}
# Questão 4 ----


# t<0 representa censura à direita
t = c(28,59,89,175,195,309,-377, -393, -421, 447, 462,-709, -744, -1106, -1206,
      34,88,137,-199, -280, 291,-299, -300, 308,351, 358,369,-370, 371,375,
      -382, 392,-429, 451,-1119, 49,87,187,293,-302, -300, 353,-360, 402,-480, 
      -486, -545, -552, -1460, -1460)

dados <- tibble(
  tempo=abs(t), 
  delta=as.numeric(t>0), 
  tumor=c(rep("Grande",15), rep("Moderado",20), rep("Pequeno",15))) %>% 
  mutate(tumor=factor(tumor, levels = c("Pequeno","Moderado","Grande") ))

## 4a  ----
library(survival)
library(survminer)
fit <- survfit(Surv(tempo, delta) ~ tumor, data = dados)
p=ggsurvplot(fit, data = dados, conf.int = T, conf.int.alpha=0.1)
p$plot
```
As curvas de Kaplan-Meier mostram que as estimativas da probabilidade de sobrevivência para o grupo com tumor moderado são menores a partir do dia 350. Entretanto, as curvas se cruzam por volta do dia 300 e todas as estimativas apresentam intervalos de confiança sobrepostos, o que indica que as curvas são próximas.

## b)

```{r}
## 4b  ----
# logrank
survdiff(formula(fit),data=dados)
# Harrington and Fleming com rho = 0.5
survdiff(formula(fit),data=dados, rho=0.5)
```
Realizamos os testes de _log-rank_ e o teste da familia Harrington and Fleming com $\rho = 0.5$ e obtemos os valores p 0.4 e 0.5 respectivamente. Em ambos os testes, não rejeitamos a hipótese nula de que as curvas de sobrevivência são iguais entre os pacientes com tumor pequeno, moderado e grande, a um nível de significância de 5%.



## c)

```{r}
## 4c  ----
fit2 <- coxph(Surv(tempo, delta) ~ tumor, data = dados)
summary(fit2)
```
A partir da saída do modelo, interpretamos que

- O risco de óbito no grupo com tumor moderado é $e^{\hat\beta_M} \approx 2$ vezes o risco no grupo com tumor pequeno.
- O risco de óbito no grupo com tumor moderado é $(e^{\hat\beta_M}-1)100\% \approx 34\%$ maior que o risco no grupo com tumor pequeno.

Entretanto as estimativas para o erro padrão das estimativas dos coeficientes de tumor moderado e grande são altas, e isso reflete que as estimativas intervalares de 95% de confiança para $e^{\beta_M}$ e $e^{\beta_G}$ contém o 1, ou, de forma equivalente, os valores p não são significativos a um nível de 5%. Dessa forma, não rejeitamos as hipóteses de que $\beta_M=0$ e $\beta_G=0$.


## d)

Testamos a hipótese $\mathrm{H}_{0}: \boldsymbol{\beta}=\mathbf{0}$ utilizando a estatística de teste da razão de verossimilhanças. A saída do teste se encontra no item c). O valor da estatística obtido foi de $1,98$ com dois graus de liberdade e um valor-p de $0,4$. Com isso, não rejeteitamos a hipótese nula a um nível de 5%.



# Questão 5

## a)

```{r, include = FALSE}
# QUESTAO 5 ----
# QUESTAO 5a ----
library(survival)
library(survminer)
library(readxl)

q5 = read_excel('data/Lista4_Hodgkins.xlsx')
q5$sex = as.factor(q5$sex)
q5$stage = as.factor(q5$stage)
q5$hist = as.factor(q5$hist)
q5
```

Primeiro, ajustando o modelo de Cox sem usar a idade:

```{r}
q5_cox_a = coxph(Surv(survivaltime, dead)~sex+stage+hist, data = q5)
summary(q5_cox_a)
```
Em seguida os resíduos martingal:

```{r}
plot(q5$age, resid(q5_cox_a), xlab = 'Idade', 
     ylab = 'Resíduo martingal', pch = 16, col = 'steelblue3')
smooth = lowess(q5$age, resid(q5_cox_a), iter = 1)
lines(smooth)
```

Observemos então que parece ser realmente uma tendência linear, indicando que transformações não são necessárias para essa variável no modelo.

## b)

```{r}
# 5.b
q5_cox_b = coxph(Surv(survivaltime, dead)~sex+stage+hist+age, data = q5)
summary(q5_cox_b)
```

Notemos que pelos testes de Wald apenas _sex_ não se mostra significativa ao nível de 5%.

## c)

Aplicando o Teste de Razão de Verossimilhanças para avaliar a exclusão de cada variável individualmente temos, para Idade:

```{r}
# 5.c
q5_cox_c_age = coxph(Surv(survivaltime, dead)~sex+stage+hist, data = q5)
anova(q5_cox_b, q5_cox_c_age)
```

Para Sexo:

```{r}
q5_cox_c_sex = coxph(Surv(survivaltime, dead)~age+stage+hist, data = q5)
anova(q5_cox_b, q5_cox_c_sex)
```

Para Estágio:

```{r}
q5_cox_c_stage = coxph(Surv(survivaltime, dead)~age+sex+hist, data = q5)
anova(q5_cox_b, q5_cox_c_stage)
```

Para Histologia:

```{r}
q5_cox_c_hist = coxph(Surv(survivaltime, dead)~age+stage+sex, data = q5)
anova(q5_cox_b, q5_cox_c_hist)
```

Notemos então que ao nível de 5% somente as variáveis Idade e Estágio serão utilizadas no modelo final.

```{r}
q5_cox = coxph(Surv(survivaltime, dead)~age+stage, data = q5)
summary(q5_cox)
```

Notemos que ter Estágio igual a 1 leva a ter uma taxa de falha 164% maior do que pacientes com Estágio igual a 0. E a cada ano a mais na idade a taxa de falha é 3.6% maior comparada com o ano anterior.

## d)

```{r}
# 5.d
q5$cox_snell = - (resid(q5_cox) - q5$dead)
q5_cox_snell = coxph(Surv(cox_snell, dead)~1, data = q5)
q5_base = basehaz(q5_cox_snell, centered = FALSE)
plot(q5_base$time, q5_base$hazard, xlab = 'Resíduo Cox-Snell' ,
     ylab = 'Estimativa da Função de Risco Acumulada', xlim = c(0,2), ylim = c(0,2))
abline(0,1)
```

Notemos então que, com excessão dos último ponto à direita, os pontos se mantém de forma considerável sobre a reta com intercepto 0 e inclinação 1 (x=y), mostrando que o ajuste parece estar razoável.

# Código Completo

```{r ref.label=knitr::all_labels(), echo=TRUE, eval=FALSE}
```
