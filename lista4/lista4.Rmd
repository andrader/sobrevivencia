---
title: "MAE0514 - Introducão a Análise de Sobrevivência - Lista 4"
author: |
  | Bruno de Castro Paul Schultze\thanks{Número USP: 10736862}
  | Rubens Santos Andrade Filho\thanks{Número USP: 10370336}
date: "`r stringr::str_to_sentence(format(Sys.time(), '%B de %Y'))`"
lang: pt-BR
header-includes:
  # - \usepackage[brazilian]{babel} # ja usando lang: pt-BR
  - \usepackage{float}
  - \usepackage{amsmath}
  - \usepackage{amsthm}
  - \floatplacement{figure}{H}
  - \usepackage{indentfirst}
  - \setlength{\parindent}{4em}
  - \setlength{\parskip}{1em}
  - \usepackage{booktabs}
  - \usepackage{dcolumn}
  - \usepackage{bm}
  - \usepackage{titling}
  - \thanksmarkseries{arabic} % \thanks footnotes com numeros
  - \usepackage[bottom]{footmisc} % corrige posição footnotes
  - \usepackage{grffile}
  - \usepackage{pdfpages}
  - \usepackage{tocloft}
  - \renewcommand{\cftsecleader}{\cftdotfill{\cftdotsep}}
  - \usepackage{amssymb}
  - \renewcommand\qedsymbol{$\blacksquare$}
  - \usepackage{pdfpages}
  - \usepackage{cleveref}
  - \usepackage{threeparttable}
output:
  pdf_document: 
    fig_caption: yes
    number_sections: no
    toc: true
    toc_depth: 3
---

\pagebreak


```{r setup, include=FALSE}
knitr::opts_chunk$set(warning=FALSE, 
                      # fig.dim = c(5,5),
                      # out.height = '40%',
                      # fig.align = 'center',
                      message=FALSE
                      )

library(tidyverse)
library(ggplot2)
library(knitr)
library(readr)
library(dplyr)


```


# Questão 1

Breve resumo do artigo:

(ii) Fabiani, M., Ramigni, M., Gobbetto, V., Mateo-Urdiales, A., Pezzotti, P., Piovesan, C. (2021). Effectiveness of the Comirnaty (BNT162b2, BioNTech/Pfizer) vaccine in preventing SARS-CoV-2 infection among healthcare workers, Treviso province, Veneto region, Italy, 27 December 2020 to 24 March 2021, _Euro Surveillance_, 26(17).

O objetivo do artigo foi estimar a eficácia da vacina Comirnaty (BNT162b2, BioNTech/Pfizer) na prevenção de infecção por SARS-CoV-2. Para isso, foi realizado um estudo de coorte retrospectivo no qual foram utilizados dados demográficos, características profissionais e datas de vacinção de 6.423 trabalhadores da área de saúde empregados na unidade local de saúde da província de Treviso em Veneto na Itália.

Primeiro, foram realizadas curvas de Kaplan-Meier para o tempo desde o inicio da campanha de vacinação até a infecção pelo vírus ou o fim do estudo para indivíduos não vacinados, que tomaram a primeira dose e ambas as doses da vacina. As curvas mostram que os pacientes que tomaram ambas as doses, e depois os que tomaram a primeira dose, apresentaram consistentemente uma menor probabilidade acumulada de infecção.

Também foi feita uma análise para o número de dias desde a administração da vacina para medir a duração do acompanhamento. A eficácia da vacina em diferentes intervalos de tempo foi estimada usando um modelo multivariável de risco proporcional de Cox, incluindo sexo, faixa etária, categoria profissional, contexto de trabalho e semana inicial de exposição como covariáveis.

A análise sugeriu que a vacina Comirnaty teve uma alta eficácia na prevenção da infecção por SARS-CoV-2 em HCW durante os intervalos de tempo após a administração em que a proteção pode ser esperada.


# Questão 2

## 2.a

```{r, include = F}
# Questão 2
library(survival)
library(survminer)

q2 <- data.frame(trat = c(rep("Sem tratamento",10),rep("Radiação",10),
rep("Radiação + BPA",10)),
tempo = c(20,21,23,24,24,26,26,27,28,30,26,28,29,29,30,
30,31,31,32,35,31,32,34,35,36,38,38,39,42,42), 
falha = c(rep(1,19),0,rep(1,8),0,0))
q2$trat = as.factor(q2$trat)
```

Primeiro vamos observar as curvas de Kaplan-Meier para cada grupo.

```{r}
q2_km = survfit(Surv(tempo, falha)~trat, data = q2, 
                    conf.type = 'log-log') 

ggsurvplot(q2_km,q2, conf.int = T, risk.table = T, tables.height = 0.35)+
  labs(x="Tempo (dias)", y=expression(hat(S)(t)))
```

Notemos então que parece existir uma ordenação entre as curvas dos três curvas, onde o grupo sem tratamento tem uma função de sobrevivência menor nos tempos superiores a 20, e o grupo com Radiação + BPA parece ter os maiores valores da função de sobrevivência.

Aplicando então o teste de Log-Rank, que tem como hipótese nula a de que as funções de sobrevivência populacionais são iguais para os três grupos:

```{r}
surv_pvalue(q2_km)
```

Vemos então que o p-valor leva à rejeição da hipótese nula sob qualquer nível de significância usual, de modo que há então evidências que a função de sobrevivência de ao menos um grupo é diferente das demais.

## 2.b

Criando as variáveis binárias:

```{r}
# 2.b
q2$z1 = ifelse(q2$trat == 'Radiação', 1, 0)
q2$z2 = ifelse(q2$trat == 'Radiação + BPA', 1, 0)
```

Como existem empates, vamos testar os coeficientes e erros-padrão gerados a partir de três algoritmos diferentes: Efron, Breslow e Cox (exato).

### Efron

```{r}
q2_cox_efron = coxph(Surv(tempo, falha)~ z1 + z2, data = q2, ties = 'efron')
summary(q2_cox_efron)
```

### Breslow

```{r}
q2_cox_breslow = coxph(Surv(tempo, falha)~ z1 + z2, data = q2, ties = 'breslow')
summary(q2_cox_breslow)
```

### Exato

```{r}
q2_cox_exact = coxph(Surv(tempo, falha)~ z1 + z2, data = q2, ties = 'exact')
summary(q2_cox_exact)
```

### Conclusão

Notemos então que ao nível de 5% todos os coeficientes parecem significativos através dos testes de Wald individuais, independentemente do algoritmo usado para empates.

## 2.c

O próprio método utilizado já nos retorna o p-valor do teste de razão de verossimilhanças comparando com o modelo nulo. Portanto, olhando para as saídas disponíveis em 2.b nós notamos que a hipótese nula desse teste é rejeitada ao nível de 5% independentemente da aproximação utilizada.

## 2.d

O próprio método utilizado também nos retorna o p-valor do teste de Wald comparando com o modelo nulo. Portanto, olhando para as saídas disponíveis em 2.b nós notamos que a hipótese nula desse teste é rejeitada ao nível de 5% independentemente da aproximação utilizada.

## 2.e

Para isso vamos comparar o modelo completo (os feitos em 2.b) com o modelo substituindo Z1 e Z2 por uma única variável (z3), que é 1 se Z1 ou Z2 forem 1, e 0 caso contrário (o que é o mesmo que falar que o efeito é o mesmo/são a mesma variável).

Para a comparação utilizaremos o teste de razão de verossimilhanças.



### Efron

```{r}
# 2.e
q2$z3 = ifelse(q2$z1 ==1 | q2$z2 ==1, 1, 0)
q2_cox_efron2 = coxph(Surv(tempo, falha)~ z3, data = q2, ties = 'efron')
anova(q2_cox_efron, q2_cox_efron2)
```

### Breslow

```{r}
q2_cox_breslow2 = coxph(Surv(tempo, falha)~ z3, data = q2, ties = 'breslow')
anova(q2_cox_breslow, q2_cox_breslow2)
```

### Exato

```{r}
q2_cox_exact2 = coxph(Surv(tempo, falha)~ z3, data = q2, ties = 'exact')
anova(q2_cox_exact, q2_cox_exact2)
```

### Conclusão

Em todas as aproximações a hipótese nula, que os efeitos são iguais, é rejeitada ao nível de 5%.

# Questão 3

# Questão 4

# Questão 5

```{r, include = FALSE}
# QUESTAO 5 ----
# QUESTAO 5a ----
library(survival)
library(survminer)
library(readxl)

q5 = read_excel('data/Lista4_Hodgkins.xlsx')
q5$sex = as.factor(q5$sex)
q5$stage = as.factor(q5$stage)
q5$hist = as.factor(q5$hist)
q5
```

Primeiro, ajustando o modelo de Cox sem usar a idade:

```{r}
q5_cox_a = coxph(Surv(survivaltime, dead)~sex+stage+hist, data = q5)
summary(q5_cox_a)
```
Em seguida os resíduos martingal:

```{r}
plot(q5$age, resid(q5_cox_a), xlab = 'Idade', 
     ylab = 'Resíduo martingal', pch = 16, col = 'steelblue3')
smooth = lowess(q5$age, resid(q5_cox_a), iter = 1)
lines(smooth)
```

Observemos então que parece ser realmente uma tendência linear, indicando que transformações não são necessárias para essa variável no modelo.

## 5.b

```{r}
# 5.b
q5_cox_b = coxph(Surv(survivaltime, dead)~sex+stage+hist+age, data = q5)
summary(q5_cox_b)
```

Notemos que pelos testes de Wald apenas _sex_ não se mostra significativa ao nível de 5%.

## 5.c

Aplicando o Teste de Razão de Verossimilhanças para avaliar a exclusão de cada variável individualmente temos, para Idade:

```{r}
# 5.c
q5_cox_c_age = coxph(Surv(survivaltime, dead)~sex+stage+hist, data = q5)
anova(q5_cox_b, q5_cox_c_age)
```

Para Sexo:

```{r}
q5_cox_c_sex = coxph(Surv(survivaltime, dead)~age+stage+hist, data = q5)
anova(q5_cox_b, q5_cox_c_sex)
```

Para Estágio:

```{r}
q5_cox_c_stage = coxph(Surv(survivaltime, dead)~age+sex+hist, data = q5)
anova(q5_cox_b, q5_cox_c_stage)
```

Para Histologia:

```{r}
q5_cox_c_hist = coxph(Surv(survivaltime, dead)~age+stage+sex, data = q5)
anova(q5_cox_b, q5_cox_c_hist)
```

Notemos então que ao nível de 5% somente as variáveis Idade e Estágio serão utilizadas no modelo final.

```{r}
q5_cox = coxph(Surv(survivaltime, dead)~age+stage, data = q5)
summary(q5_cox)
```

Notemos que ter Estágio igual a 1 leva a ter uma taxa de falha 164% maior do que pacientes com Estágio igual a 0. E a cada ano a mais na idade a taxa de falha é 3.6% maior comparada com o ano anterior.

## 5.d

```{r}
# 5.d
q5$cox_snell = - (resid(q5_cox) - q5$dead)
q5_cox_snell = coxph(Surv(cox_snell, dead)~1, data = q5)
q5_base = basehaz(q5_cox_snell, centered = FALSE)
plot(q5_base$time, q5_base$hazard, xlab = 'Resíduo Cox-Snell' ,
     ylab = 'Estimativa da Função de Risco Acumulada', xlim = c(0,2), ylim = c(0,2))
abline(0,1)
```

Notemos então que, com excessão dos último ponto à direita, os pontos se mantém de forma considerável sobre a reta com intercepto 0 e inclinação 1 (x=y), mostrando que o ajuste parece estar razoável.

# Código Completo

```{r ref.label=knitr::all_labels(), echo=TRUE, eval=FALSE}
```
